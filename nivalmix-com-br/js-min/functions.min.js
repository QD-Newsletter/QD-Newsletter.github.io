!function() {
    var e = "close";
    $(document).ready(function() {
        var n = $(".qd-v1-modal-newsletter");
        n.find(".qd-v1-modal-newsletter-step-1").show(), n.modal(), n.on("hidden.bs.modal", function() {
            window.parent.postMessage("QdSn1Msg|" + e, "*");
        }), $(".qd-content-coupon").html((location.search.match(/code=([^&]+)/i) || [ "" ]).pop());
    }), $(function() {
        var e = $("form"), n = e.find("[name=qd_email]");
        e.validate({
            rules: {
                email: {
                    email: !0
                }
            },
            submitHandler: function(e) {
                var a = $(e);
                if (a.valid()) {
                    var o = a.find("[name]");
                    n = n.filter(o), a.addClass("qd-loading");
                    var t = function(e) {
                        $.ajax({
                            url: "//api.ipify.org?format=jsonp",
                            dataType: "jsonp",
                            success: function(e) {
                                t(e.ip);
                            },
                            error: function() {
                                $.ajax({
                                    url: "//www.telize.com/jsonip",
                                    dataType: "jsonp",
                                    success: function(e) {
                                        t(e.ip);
                                    },
                                    error: function(e) {
                                        t(null);
                                    }
                                });
                            }
                        });
                        var o = a.serializeObject(), t = function(t) {
                            o.userId = e, o.ip = t, o.id = (n.val() || "").toLowerCase().replace(/[^a-z0-9]/gi, function(e) {
                                return "-" + e.charCodeAt(0) + "-";
                            }), $.ajax({
                                url: "//api.vtexcrm.com.br/nivalmix/dataentities/NL/documents",
                                type: "PATCH",
                                dataType: "json",
                                headers: {
                                    Accept: "application/vnd.vtex.ds.v10+json",
                                    "Content-Type": "application/json; charset=utf-8"
                                },
                                data: JSON.stringify(o),
                                success: function(e) {
                                    a.addClass("qd-form-success"), a.trigger("QD.crmSuccess", [ e ]);
                                },
                                error: function() {
                                    alert("Desculpe, não foi possível enviar seu formulário!");
                                },
                                complete: function() {
                                    a.removeClass("qd-loading");
                                }
                            });
                        };
                    };
                    return $.ajax({
                        url: "//api.vtexcrm.com.br/nivalmix/dataentities/CL/search?_fields=id&email=" + (n.val() || "---"),
                        type: "GET",
                        dataType: "json",
                        headers: {
                            Accept: "application/vnd.vtex.ds.v10+json"
                        },
                        success: function(e) {
                            t(e.length ? e[0].id : null);
                        },
                        error: function() {
                            t(null);
                        }
                    }), !1;
                }
            },
            errorPlacement: function(e, n) {}
        });
    }), $(window).on("QD.crmSuccess", function(n, a) {
        $(".qd-v1-modal-newsletter");
        e = "success";
    });
}();